<?php

namespace App\Http\Controllers\Api;

use App\Http\Controllers\Controller;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Http;
use Illuminate\Support\Facades\Log;
use App\Models\Product;
use App\Models\Invoice;
use App\Models\InvoiceItem;
use App\Models\AiUsageLog;
use App\Models\ConversationHistory;
use App\Models\Customer;
use Carbon\Carbon;
use Illuminate\Support\Str;

class AIController extends Controller
{
    /**
     * Handle the chat request.
     */
    public function chat(Request $request)
    {
        $request->validate([
            'message' => 'required|string',
        ]);

        $userMessage = trim($request->input('message'));

        try {
            // ðŸ”§ CÃ“DIGOS DE DESARROLLO (sin consumir tokens)
            $devCodes = [
                '123' => [
                    'reply' => 'ðŸ”§ [DEV] Navegando a GestiÃ³n de Productos...',
                    'action' => [
                        'type' => 'navigate',
                        'payload' => [
                            'name' => 'POSModule',
                            'params' => ['module' => 'products']
                        ]
                    ]
                ],
                '456' => [
                    'reply' => 'ðŸ”§ [DEV] Navegando a POS...',
                    'action' => [
                        'type' => 'navigate',
                        'payload' => [
                            'name' => 'POSModule',
                            'params' => ['module' => 'pos']
                        ]
                    ]
                ],
                '789' => [
                    'reply' => 'ðŸ”§ [DEV] Navegando a Dashboard...',
                    'action' => [
                        'type' => 'navigate',
                        'payload' => [
                            'name' => 'POSModule',
                            'params' => ['module' => 'dashboard']
                        ]
                    ]
                ],
                '111' => [
                    'reply' => 'ðŸ”§ [DEV] Navegando a Facturas...',
                    'action' => [
                        'type' => 'navigate',
                        'payload' => [
                            'name' => 'POSModule',
                            'params' => ['module' => 'invoices']
                        ]
                    ]
                ],
                '222' => [
                    'reply' => 'ðŸ”§ [DEV] Navegando a Clientes...',
                    'action' => [
                        'type' => 'navigate',
                        'payload' => [
                            'name' => 'POSModule',
                            'params' => ['module' => 'customers']
                        ]
                    ]
                ],
                '333' => [
                    'reply' => 'ðŸ”§ [DEV] Navegando a Reportes...',
                    'action' => [
                        'type' => 'navigate',
                        'payload' => [
                            'name' => 'POSModule',
                            'params' => ['module' => 'reports']
                        ]
                    ]
                ],
                'testuno' => [
                    'reply' => 'ðŸŽ¯ [TEST] Creando descuento y enviando solo al 3134540533...',
                    'action' => null,
                    'execute_action' => [
                        'type' => 'create_campaign',
                        'params' => [
                            'discount' => [
                                'name' => 'Test Uno ' . date('His'),
                                'code' => 'UNO' . date('His'),
                                'type' => 'percentage',
                                'value' => 50,
                                'duration_days' => 2
                            ],
                            'whatsapp' => [
                                'message' => 'ðŸŽ CÃ³digo exclusivo UNO' . date('His') . ' para 50% de descuento por 2 dÃ­as',
                                'target' => 'specific',
                                'customer_ids' => [10]
                            ]
                        ]
                    ]
                ],
                'debug_wa' => [
                    'reply' => 'ðŸ› [DEBUG] Enviando 1 mensaje WhatsApp a 3134540533 para depurar...',
                    'action' => null,
                    'execute_action' => [
                        'type' => 'send_whatsapp',
                        'params' => [
                            'message' => 'ðŸ› Test de depuraciÃ³n WhatsApp',
                            'target' => 'specific',
                            'customer_ids' => [1]
                        ]
                    ]
                ],
                'test_whatsapp' => [
                    'reply' => 'ðŸ”§ [DEV] Enviando WhatsApp a todos los clientes...\n\nâ³ Esto puede tomar unos segundos, por favor espera...',
                    'action' => null,
                    'execute_action' => [
                        'type' => 'send_whatsapp',
                        'params' => [
                            'message' => 'Â¡Oferta especial! Usa el cÃ³digo KAEL891 para 100% de descuento solo hoy ðŸŽ',
                            'target' => 'all'
                        ]
                    ]
                ],
                'test_discount' => [
                    'reply' => 'ðŸ”§ [DEV] Creando descuento de prueba: TEST50 con 50% de descuento por 7 dÃ­as...',
                    'action' => null,
                    'execute_action' => [
                        'type' => 'create_discount',
                        'params' => [
                            'name' => 'Descuento Prueba',
                            'code' => 'TEST50',
                            'type' => 'percentage',
                            'value' => 50,
                            'duration_days' => 7
                        ]
                    ]
                ],
                'test_campaign' => [
                    'reply' => 'ðŸ”§ [DEV] Creando campaÃ±a completa: descuento + WhatsApp...',
                    'action' => null,
                    'execute_action' => [
                        'type' => 'create_campaign',
                        'params' => [
                            'discount' => [
                                'name' => 'CampaÃ±a Test ' . date('His'),
                                'code' => 'TEST' . date('His'),
                                'type' => 'percentage',
                                'value' => 30,
                                'duration_days' => 3
                            ],
                            'whatsapp' => [
                                'message' => 'ðŸŽ‰ Â¡Nueva promociÃ³n! Usa TEST' . date('His') . ' para 30% descuento por 3 dÃ­as',
                                'target' => 'all'
                            ]
                        ]
                    ]
                ],
                '000' => [
                    'reply' => 'ðŸ”§ [DEV] CÃ³digos disponibles:\n\nðŸ“ NAVEGACIÃ“N:\nâ€¢ 123 = Productos\nâ€¢ 456 = POS\nâ€¢ 789 = Dashboard\nâ€¢ 111 = Facturas\nâ€¢ 222 = Clientes\nâ€¢ 333 = Reportes\n\nðŸŽ¯ ACCIONES:\nâ€¢ testuno = Descuento + WhatsApp a 3134540533\nâ€¢ debug_wa = WhatsApp test a 1 nÃºmero\nâ€¢ test_whatsapp = Enviar WhatsApp a todos\nâ€¢ test_discount = Crear descuento TEST50\nâ€¢ test_campaign = CampaÃ±a completa',
                    'action' => null
                ]
            ];

            // Verificar si es un cÃ³digo de desarrollo
            if (isset($devCodes[$userMessage])) {
                $userId = auth()->id() ?? $request->ip();
                $executionKey = "dev_code_{$userMessage}_" . md5($userId);

                $lastExecution = cache($executionKey);
                if ($lastExecution && (time() - $lastExecution) < 3) {
                    Log::warning("[DEV CODE] EjecuciÃ³n duplicada bloqueada: {$userMessage}");
                    return response()->json([
                        'reply' => json_encode(['reply' => 'â³ Espera un momento antes de ejecutar de nuevo...']),
                        'status' => 'success'
                    ]);
                }

                cache([$executionKey => time()], 5);
                Log::info("[DEV CODE] Usuario usÃ³ cÃ³digo: {$userMessage}");

                $devResponse = $devCodes[$userMessage];

                if (isset($devResponse['execute_action'])) {
                    $actionResult = $this->executeAIAction($devResponse['execute_action']);
                    $devResponse['action_result'] = $actionResult;

                    if (isset($actionResult['message'])) {
                        $devResponse['reply'] .= "\n\nâœ… " . $actionResult['message'];
                    }
                }

                return response()->json([
                    'reply' => json_encode($devResponse),
                    'status' => 'success'
                ]);
            }

            // ðŸ“ GESTIÃ“N DE SESIÃ“N CONVERSACIONAL
            $sessionId = $request->input('session_id');
            if (!$sessionId) {
                $userId = auth()->id() ?? 'guest_' . $request->ip();
                $sessionId = 'sess_' . md5($userId . '_' . date('Ymd'));
            }

            // 1. Build lightweight system prompt (NO CONTEXT STUFFING!)
            $systemPrompt = $this->buildSystemPrompt();

            // 2. Recuperar historial de conversaciÃ³n (reducido para evitar confusiÃ³n)
            $conversationHistory = ConversationHistory::getRecentMessages($sessionId, 3);

            // 3. Guardar mensaje del usuario
            ConversationHistory::create([
                'user_id' => auth()->id(),
                'session_id' => $sessionId,
                'role' => 'user',
                'content' => $userMessage,
            ]);

            // 4. Call AI with agent loop (handles tools automatically)
            $response = $this->callGroqAPI($systemPrompt, $userMessage, $conversationHistory);

            // 5. Guardar respuesta del asistente
            $aiResponse = json_decode($response, true);
            $assistantReply = $aiResponse['reply'] ?? 'Sin respuesta';
            ConversationHistory::create([
                'user_id' => auth()->id(),
                'session_id' => $sessionId,
                'role' => 'assistant',
                'content' => $assistantReply,
            ]);

            return response()->json([
                'reply' => $response,
                'session_id' => $sessionId,
                'status' => 'success'
            ]);

        } catch (\Exception $e) {
            Log::error('AI Chat Error: ' . $e->getMessage());
            return response()->json([
                'reply' => 'Lo siento, tuve un problema al procesar tu solicitud. Por favor intenta de nuevo.',
                'error' => $e->getMessage(),
                'status' => 'error'
            ], 500);
        }
    }

    /**
     * Build lightweight system prompt (NO CONTEXT STUFFING!)
     */
    private function buildSystemPrompt()
    {
        $currentDate = now()->locale('es')->isoFormat('dddd, D [de] MMMM [de] YYYY');
        $currentTime = now()->format('H:i');

        return <<<EOT
Eres "105 IA", asistente virtual inteligente del sistema POS. SÃ© amigable, conversacional y muy Ãºtil.

ðŸŽ¯ TUS CAPACIDADES:
Tienes herramientas para consultar datos en tiempo real:
â€¢ search_products(query, filter, limit) - Buscar productos
â€¢ search_customers(query) - Buscar clientes [CRÃTICO: usar para obtener IDs]
â€¢ search_categories(query) - Buscar categorÃ­as [CRÃTICO: usar para obtener IDs de categorÃ­as]
â€¢ get_sales_report(period) - EstadÃ­sticas de ventas
â€¢ get_low_stock_products(limit) - Productos con stock bajo
â€¢ search_invoices(customer_name, date, limit) - Buscar facturas
â€¢ execute_action(action_type, params) - Ejecutar acciones (descuentos, WhatsApp, productos, etc)

ðŸ”§ REGLAS IMPORTANTES:

1. **NUNCA inventes datos** - Usa herramientas para obtener informaciÃ³n real

2. **NAVEGACIÃ“N** (NO es herramienta - va en respuesta JSON):
   Frases: "llevame a X", "muestra X", "abre X", "ve a X", "ir a X", "quiero ver X"
   MÃ³dulos: products, pos, dashboard, invoices, customers, suppliers, categories, reports, settings
   
   Ejemplo:
   Usuario: "llevame a productos"
   Respuesta: {"reply": "Â¡Claro! Te llevo al mÃ³dulo de productos ðŸ“¦", "action": {"type": "navigate", "payload": {"name": "POSModule", "params": {"module": "products"}}}}

3. **CONSULTAS DE DATOS** (SÃ usa herramientas):
   Usuario: "muestra productos" â†’ Llama search_products() â†’ {"reply": "datos formateados", "action": null}
   Usuario: "ventas de hoy" â†’ Llama get_sales_report('today') â†’ {"reply": "estadÃ­sticas", "action": null}

4. **CREAR PRODUCTOS** - SÃ‰ PROACTIVO:
   Usuario: "crea producto X con categorÃ­a Y"
   
   SI FALTA INFO â†’ PÃ­dela especÃ­ficamente:
   "Para crear el producto necesito: nombre, categorÃ­a, precio de venta, precio de costo, y stock inicial."
   
   SI TIENE INFO COMPLETA:
   - Paso 1: Si usuario da nombre categorÃ­a â†’ search_categories(query='nombre categorÃ­a') para obtener category_id
   - Paso 2: Si categorÃ­a no existe â†’ Pregunta si quiere crearla o usar otra
   - Paso 3: execute_action('create_product', params con category_id numÃ©rico)
   - Paso 4: RESPONDE con resultado

5. **ACCIONES MULTI-PASO**:
   Ejemplo: "crea descuento para Maria"
   - Paso 1: search_customers(query='Maria') â†’ obtiene ID
   - Paso 2: execute_action('create_discount', params con customer_id)
   - Paso 3: RESPONDE con resultado (NO mÃ¡s herramientas)

6. **SALUDOS**: "hola", "hi", "buenos dÃ­as" â†’ Responde directamente sin herramientas

7. **DETENTE** cuando hayas obtenido lo que el usuario pidiÃ³

8. **ERRORES** - SÃ‰ CLARO Y ÃšTIL:
   Si algo falla â†’ Explica QUÃ‰ fallÃ³ y QUÃ‰ se necesita
   Ejemplo: "No puedo crear el producto porque la categorÃ­a 'Hogar' no existe en el sistema. Â¿Quieres que la cree primero o usar otra categorÃ­a existente?"

9. **WhatsApp**: target debe ser "all", "active" o "specific" (con customer_ids)

10. **FORMATO RESPUESTA**:
   SIEMPRE JSON: {"reply": "texto amigable y Ãºtil", "action": null o objeto_navegaciÃ³n}
   
Â¡SÃ© inteligente, proactivo y ayuda al usuario a completar sus tareas!

Hoy: {$currentDate}, {$currentTime}
EOT;
    }

    /**
     * Get tools definition for Groq API
     */
    private function getToolsDefinition()
    {
        return [
            [
                'type' => 'function',
                'function' => [
                    'name' => 'search_products',
                    'description' => 'Buscar productos en el inventario por nombre, ID o criterios de filtro. Usa esto cuando el usuario pregunte por productos, stock, o quiera ver el inventario.',
                    'parameters' => [
                        'type' => 'object',
                        'properties' => [
                            'query' => [
                                'type' => 'string',
                                'description' => 'TÃ©rmino de bÃºsqueda (nombre del producto o ID). Deja vacÃ­o para listar todos.'
                            ],
                            'filter' => [
                                'type' => 'string',
                                'enum' => ['all', 'low-stock', 'out-of-stock', 'active', 'inactive'],
                                'description' => 'Criterio de filtro'
                            ],
                            'limit' => [
                                'type' => 'integer',
                                'description' => 'NÃºmero mÃ¡ximo de resultados',
                                'default' => 10
                            ]
                        ],
                        'required' => []
                    ]
                ]
            ],
            [
                'type' => 'function',
                'function' => [
                    'name' => 'search_customers',
                    'description' => 'CRÃTICO: Buscar clientes por nombre, telÃ©fono, email o documento. SIEMPRE usa esta herramienta para encontrar el ID de un cliente antes de ejecutar acciones que lo requieran.',
                    'parameters' => [
                        'type' => 'object',
                        'properties' => [
                            'query' => [
                                'type' => 'string',
                                'description' => 'TÃ©rmino de bÃºsqueda (nombre, telÃ©fono, email o documento del cliente)'
                            ]
                        ],
                        'required' => ['query']
                    ]
                ]
            ],
            [
                'type' => 'function',
                'function' => [
                    'name' => 'get_sales_report',
                    'description' => 'Obtener estadÃ­sticas de ventas para un perÃ­odo especÃ­fico de tiempo',
                    'parameters' => [
                        'type' => 'object',
                        'properties' => [
                            'period' => [
                                'type' => 'string',
                                'enum' => ['today', 'yesterday', 'week', 'month', 'last_7_days'],
                                'description' => 'PerÃ­odo de tiempo para el reporte'
                            ]
                        ],
                        'required' => ['period']
                    ]
                ]
            ],
            [
                'type' => 'function',
                'function' => [
                    'name' => 'get_low_stock_products',
                    'description' => 'Obtener lista de productos con stock en o por debajo del mÃ­nimo',
                    'parameters' => [
                        'type' => 'object',
                        'properties' => [
                            'limit' => [
                                'type' => 'integer',
                                'description' => 'NÃºmero mÃ¡ximo de resultados',
                                'default' => 20
                            ]
                        ],
                        'required' => []
                    ]
                ]
            ],
            [
                'type' => 'function',
                'function' => [
                    'name' => 'search_invoices',
                    'description' => 'Buscar facturas por cliente, fecha u otros criterios',
                    'parameters' => [
                        'type' => 'object',
                        'properties' => [
                            'customer_name' => [
                                'type' => 'string',
                                'description' => 'Nombre del cliente (bÃºsqueda parcial)'
                            ],
                            'date' => [
                                'type' => 'string',
                                'enum' => ['today', 'yesterday'],
                                'description' => 'Filtrar por fecha'
                            ],
                            'limit' => [
                                'type' => 'integer',
                                'description' => 'NÃºmero mÃ¡ximo de resultados',
                                'default' => 20
                            ]
                        ],
                        'required' => []
                    ]
                ]
            ],
            [
                'type' => 'function',
                'function' => [
                    'name' => 'execute_action',
                    'description' => 'Ejecutar acciones de negocio como crear descuentos, enviar WhatsApp, crear productos, etc. IMPORTANTE: Si la acciÃ³n requiere customer_ids, primero busca al cliente con search_customers. DESPUÃ‰S DE EJECUTAR, NO VUELVAS A LLAMAR ESTA FUNCIÃ“N - responde al usuario con el resultado.',
                    'parameters' => [
                        'type' => 'object',
                        'properties' => [
                            'action_type' => [
                                'type' => 'string',
                                'enum' => ['create_discount', 'send_whatsapp', 'create_campaign', 'create_product', 'create_category'],
                                'description' => 'Tipo de acciÃ³n a ejecutar'
                            ],
                            'params' => [
                                'type' => 'object',
                                'description' => 'ParÃ¡metros especÃ­ficos de la acciÃ³n. Para create_discount: {name, code, type, value, duration_days}. Para send_whatsapp: {message, target (all|active|specific), customer_ids (si target=specific)}. Para create_campaign: {discount: {...}, whatsapp: {...}}.'
                            ]
                        ],
                        'required' => ['action_type', 'params']
                    ]
                ]
            ]
        ];
    }

    /**
     * Call Groq API with agent loop (handles tools automatically)
     */
    private function callGroqAPI($systemPrompt, $userMessage, $conversationHistory = [], $maxIterations = 5)
    {
        // Build initial messages array
        $messages = [
            ['role' => 'system', 'content' => $systemPrompt]
        ];

        // Add conversation history
        if (!empty($conversationHistory)) {
            $messages = array_merge($messages, $conversationHistory);
        }

        // Add current user message
        $messages[] = ['role' => 'user', 'content' => $userMessage];

        $iterations = 0;

        while ($iterations < $maxIterations) {
            $iterations++;

            Log::info("[Agent Loop] Iteration {$iterations}/{$maxIterations}");

            // Call Groq API with tools
            $response = $this->callGroqAPIWithTools($messages);

            if (!$response) {
                Log::error("[Agent Loop] API call failed");
                break;
            }

            $message = $response['choices'][0]['message'];
            $finishReason = $response['choices'][0]['finish_reason'];

            Log::info("[Agent Loop] Finish reason: {$finishReason}");

            // Add assistant message to conversation
            $messages[] = $message;

            // Check if AI wants to call a tool
            if ($finishReason === 'tool_calls' && isset($message['tool_calls'])) {
                Log::info("[Agent Loop] AI requested " . count($message['tool_calls']) . " tool call(s)");

                // Execute each tool call
                foreach ($message['tool_calls'] as $toolCall) {
                    $toolName = $toolCall['function']['name'];
                    $toolArgs = json_decode($toolCall['function']['arguments'], true);

                    Log::info("[Tool Call] {$toolName}", $toolArgs ?? []);

                    // Execute the tool
                    $toolResult = $this->executeToolCall($toolName, $toolArgs ?? []);

                    Log::info("[Tool Result] {$toolName}", ['result' => $toolResult]);

                    // Add tool result to messages
                    $messages[] = [
                        'role' => 'tool',
                        'tool_call_id' => $toolCall['id'],
                        'name' => $toolName,
                        'content' => json_encode($toolResult, JSON_UNESCAPED_UNICODE)
                    ];
                }

                // Continue loop to let AI process tool results
                continue;
            }

            // If finish_reason is 'stop', AI has final response
            if ($finishReason === 'stop') {
                $finalContent = $message['content'] ?? '';

                Log::info("[Agent Loop] Final response received");

                if (!$finalContent) {
                    return json_encode([
                        'reply' => 'No pude generar una respuesta. Por favor intenta de nuevo.',
                        'action' => null
                    ]);
                }

                // Verify it's valid JSON
                $decoded = json_decode($finalContent, true);
                if (json_last_error() === JSON_ERROR_NONE) {
                    return $finalContent;
                }

                // If not valid JSON, wrap it
                return json_encode([
                    'reply' => $finalContent,
                    'action' => null
                ], JSON_UNESCAPED_UNICODE);
            }

            // Handle other finish reasons
            Log::warning("[Agent Loop] Unexpected finish_reason: {$finishReason}");
            break;
        }

        // Max iterations reached or error occurred
        Log::warning("[Agent Loop] Ended after {$iterations} iterations");
        return json_encode([
            'reply' => 'Lo siento, la consulta es muy compleja. Â¿Puedes ser mÃ¡s especÃ­fico?',
            'action' => null
        ]);
    }

    /**
     * Call Groq API with tools definition
     */
    private function callGroqAPIWithTools($messages)
    {
        // Sistema de rotaciÃ³n de mÃºltiples API Keys
        $apiKeys = array_filter([
            env('GROQ_API_KEY_1'),
            env('GROQ_API_KEY_2'),
            env('GROQ_API_KEY_3'),
            env('GROQ_API_KEY_4'),
            env('GROQ_API_KEY_5'),
            env('GROQ_API_KEY_6'),
            env('GROQ_API_KEY_7'),
            env('GROQ_API_KEY_8'),
            env('GROQ_API_KEY_9'),
            env('GROQ_API_KEY_10'),
        ]);

        if (empty($apiKeys)) {
            Log::error('[Groq API] No API keys configured');
            return null;
        }

        $startTime = microtime(true);
        $lastError = null;

        foreach ($apiKeys as $index => $apiKey) {
            $keyIndex = $index + 1;
            $keyLast4 = substr($apiKey, -4);

            Log::info("[Groq API] Trying API Key #{$keyIndex}");

            try {
                $response = Http::timeout(30)->withHeaders([
                    'Authorization' => 'Bearer ' . $apiKey,
                    'Content-Type' => 'application/json',
                ])->post('https://api.groq.com/openai/v1/chat/completions', [
                    'model' => 'llama-3.3-70b-versatile',
                    'messages' => $messages,
                    'tools' => $this->getToolsDefinition(),
                    'tool_choice' => 'auto',
                    'temperature' => 0.3,
                    'max_tokens' => 1000,
                ]);

                $responseTime = (int)((microtime(true) - $startTime) * 1000);

                if ($response->successful()) {
                    Log::info("[Groq API] âœ… Success with API Key #{$keyIndex}");

                    $responseData = $response->json();

                    // Extract usage metrics
                    $usage = $responseData['usage'] ?? [];
                    $promptTokens = $usage['prompt_tokens'] ?? 0;
                    $completionTokens = $usage['completion_tokens'] ?? 0;
                    $totalTokens = $usage['total_tokens'] ?? 0;

                    Log::info("[Token Usage] Prompt: {$promptTokens}, Completion: {$completionTokens}, Total: {$totalTokens}");

                    // Log usage
                    try {
                        $lastUserMessage = '';
                        foreach (array_reverse($messages) as $msg) {
                            if (isset($msg['role']) && $msg['role'] === 'user') {
                                $lastUserMessage = $msg['content'] ?? '';
                                break;
                            }
                        }

                        AiUsageLog::create([
                            'user_id' => auth()->id(),
                            'api_key_index' => $keyIndex,
                            'api_key_last_4' => $keyLast4,
                            'user_message' => substr($lastUserMessage, 0, 1000),
                            'prompt_tokens' => $promptTokens,
                            'completion_tokens' => $completionTokens,
                            'total_tokens' => $totalTokens,
                            'status' => 'success',
                            'response_time_ms' => $responseTime,
                            'model' => 'llama-3.3-70b-versatile',
                            'endpoint' => 'chat',
                            'ip_address' => request()->ip(),
                        ]);
                    } catch (\Exception $e) {
                        Log::error("[AI Usage Log] Error: " . $e->getMessage());
                    }

                    return $responseData;
                }

                // Handle errors
                $statusCode = $response->status();
                $errorBody = $response->body();

                if ($statusCode === 429) {
                    Log::warning("[Groq API] âš ï¸ Rate limit on API Key #{$keyIndex}");

                    try {
                        AiUsageLog::create([
                            'user_id' => auth()->id(),
                            'api_key_index' => $keyIndex,
                            'api_key_last_4' => $keyLast4,
                            'user_message' => '',
                            'status' => 'rate_limited',
                            'error_message' => 'Rate limit exceeded',
                            'response_time_ms' => $responseTime,
                            'model' => 'llama-3.3-70b-versatile',
                            'endpoint' => 'chat',
                            'ip_address' => request()->ip(),
                        ]);
                    } catch (\Exception $e) {
                        Log::error("[AI Usage Log] Error: " . $e->getMessage());
                    }

                    $lastError = "Rate limit exceeded";
                    continue;
                }

                Log::error("[Groq API] âŒ Error {$statusCode} with API Key #{$keyIndex}: {$errorBody}");

                try {
                    AiUsageLog::create([
                        'user_id' => auth()->id(),
                        'api_key_index' => $keyIndex,
                        'api_key_last_4' => $keyLast4,
                        'user_message' => '',
                        'status' => 'error',
                        'error_message' => substr($errorBody, 0, 1000),
                        'response_time_ms' => $responseTime,
                        'model' => 'llama-3.3-70b-versatile',
                        'endpoint' => 'chat',
                        'ip_address' => request()->ip(),
                    ]);
                } catch (\Exception $e) {
                    Log::error("[AI Usage Log] Error: " . $e->getMessage());
                }

                $lastError = $errorBody;
                continue;

            } catch (\Exception $e) {
                Log::error("[Groq API] Exception with API Key #{$keyIndex}: " . $e->getMessage());
                $lastError = $e->getMessage();
                continue;
            }
        }

        // All API keys failed
        Log::error("[Groq API] âŒ All API keys exhausted. Last error: {$lastError}");
        return null;
    }

    /**
     * Execute a tool call requested by the AI
     */
    private function executeToolCall($toolName, $args)
    {
        try {
            switch ($toolName) {
                case 'search_products':
                    return $this->toolSearchProducts($args);

                case 'search_customers':
                return $this->toolSearchCustomers($args);

            case 'search_categories':
                return $this->toolSearchCategories($args);

                case 'get_sales_report':
                    return $this->toolGetSalesReport($args);

                case 'get_low_stock_products':
                    return $this->toolGetLowStockProducts($args);

                case 'search_invoices':
                    return $this->toolSearchInvoices($args);

                case 'execute_action':
                    return $this->toolExecuteAction($args);

                default:
                    return ['error' => 'Unknown tool: ' . $toolName];
            }
        } catch (\Exception $e) {
            Log::error("[Tool Execution Error] {$toolName}: " . $e->getMessage());
            return ['error' => $e->getMessage()];
        }
    }

    /**
     * Tool: Search products
     */
    private function toolSearchProducts($args)
    {
        $query = $args['query'] ?? '';
        $filter = $args['filter'] ?? 'all';
        $limit = $args['limit'] ?? 10;

        $productsQuery = Product::query();

        // Apply search
        if ($query) {
            $productsQuery->where(function($q) use ($query) {
                $q->where('name', 'LIKE', "%{$query}%")
                  ->orWhere('id', $query);
            });
        }

        // Apply filter
        switch ($filter) {
            case 'low-stock':
                $productsQuery->where('manage_stock', true)
                             ->whereRaw('current_stock <= min_stock');
                break;
            case 'out-of-stock':
                $productsQuery->where('current_stock', '<=', 0);
                break;
            case 'active':
                $productsQuery->where('active', true);
                break;
            case 'inactive':
                $productsQuery->where('active', false);
                break;
        }

        $products = $productsQuery->limit($limit)
            ->get(['id', 'name', 'sale_price', 'cost_price', 'current_stock', 'min_stock', 'active'])
            ->toArray();

        return [
            'products' => $products,
            'count' => count($products),
            'filter_applied' => $filter
        ];
    }

    /**
     * Tool: Search customers
     */
    private function toolSearchCustomers($args)
    {
        $query = $args['query'] ?? '';

        if (empty($query)) {
            return ['error' => 'Query parameter is required'];
        }

        $customers = Customer::where(function($q) use ($query) {
            $q->where('name', 'LIKE', "%{$query}%")
              ->orWhere('email', 'LIKE', "%{$query}%")
              ->orWhere('phone', 'LIKE', "%{$query}%")
              ->orWhere('document_number', 'LIKE', "%{$query}%");
        })
        ->limit(10)
        ->get(['id', 'name', 'email', 'phone', 'document_number'])
        ->toArray();

        return [
            'customers' => $customers,
            'count' => count($customers)
        ];
    }

    /**
     * Tool: Get sales report
     */
    private function toolGetSalesReport($args)
    {
        $period = $args['period'] ?? 'today';

        $dateQuery = match($period) {
            'today' => [['date', '=', Carbon::today()]],
            'yesterday' => [['date', '=', Carbon::yesterday()]],
            'week' => [['date', '>=', Carbon::now()->startOfWeek()]],
            'month' => [['date', '>=', Carbon::now()->startOfMonth()]],
            'last_7_days' => [['date', '>=', Carbon::now()->subDays(7)]],
            default => [['date', '=', Carbon::today()]]
        };

        $total = Invoice::where('type', 'invoice')
            ->where($dateQuery)
            ->where('status', '!=', 'cancelled')
            ->sum('total');

        $count = Invoice::where('type', 'invoice')
            ->where($dateQuery)
            ->where('status', '!=', 'cancelled')
            ->count();

        // Get top selling products for this period
        $dateFilter = match($period) {
            'today' => Carbon::today(),
            'yesterday' => Carbon::yesterday(),
            'week' => Carbon::now()->startOfWeek(),
            'month' => Carbon::now()->startOfMonth(),
            'last_7_days' => Carbon::now()->subDays(7),
            default => Carbon::today()
        };

        $topProducts = InvoiceItem::whereHas('invoice', function($query) use ($dateFilter, $period) {
                if (in_array($period, ['today', 'yesterday'])) {
                    $query->where('type', 'invoice')
                          ->whereDate('date', $dateFilter)
                          ->where('status', '!=', 'cancelled');
                } else {
                    $query->where('type', 'invoice')
                          ->where('date', '>=', $dateFilter)
                          ->where('status', '!=', 'cancelled');
                }
            })
            ->selectRaw('product_name, sum(quantity) as total_qty, sum(unit_price * quantity) as total_revenue')
            ->groupBy('product_name')
            ->orderByDesc('total_qty')
            ->limit(5)
            ->get()
            ->toArray();

        return [
            'period' => $period,
            'total_sales' => $total,
            'invoice_count' => $count,
            'average_ticket' => $count > 0 ? round($total / $count, 2) : 0,
            'top_products' => $topProducts
        ];
    }

    /**
     * Tool: Get low stock products
     */
    private function toolGetLowStockProducts($args)
    {
        $limit = $args['limit'] ?? 20;

        $products = Product::where('manage_stock', true)
            ->whereRaw('current_stock <= min_stock')
            ->limit($limit)
            ->get(['id', 'name', 'current_stock', 'min_stock', 'sale_price'])
            ->toArray();

        return [
            'products' => $products,
            'count' => count($products)
        ];
    }

    /**
     * Tool: Search invoices
     */
    private function toolSearchInvoices($args)
    {
        $customerName = $args['customer_name'] ?? null;
        $date = $args['date'] ?? null;
        $limit = $args['limit'] ?? 20;

        $query = Invoice::with('customer:id,name')
            ->where('type', 'invoice');

        if ($date === 'today') {
            $query->whereDate('date', Carbon::today());
        } elseif ($date === 'yesterday') {
            $query->whereDate('date', Carbon::yesterday());
        }

        if ($customerName) {
            $query->whereHas('customer', function($q) use ($customerName) {
                $q->where('name', 'LIKE', "%{$customerName}%");
            });
        }

        $invoices = $query->limit($limit)
            ->orderBy('date', 'desc')
            ->get(['id', 'number', 'customer_id', 'date', 'total', 'status', 'payment_method'])
            ->map(function($invoice) {
                return [
                    'id' => $invoice->id,
                    'number' => $invoice->number,
                    'customer_name' => $invoice->customer?->name ?? 'Cliente General',
                    'date' => $invoice->date,
                    'total' => $invoice->total,
                    'status' => $invoice->status,
                    'payment_method' => $invoice->payment_method
                ];
            })
            ->toArray();

        return [
            'invoices' => $invoices,
            'count' => count($invoices)
        ];
    }

    /**
     * Tool: Execute action
     */
    private function toolExecuteAction($args)
    {
        $actionType = $args['action_type'] ?? null;
        $params = $args['params'] ?? [];

        if (!$actionType) {
            return ['error' => 'action_type is required'];
        }

        // Reuse existing execution logic
        $result = $this->executeAIAction([
            'type' => $actionType,
            'params' => $params
        ]);

        return $result;
    }

    /**
     * Execute AI action (reused from old system)
     */
    private function executeAIAction($actionData)
    {
        try {
            $actionType = $actionData['type'] ?? null;

            switch ($actionType) {
                case 'create_discount':
                    return $this->createDiscountAction($actionData['params'] ?? []);

                case 'send_whatsapp':
                    return $this->sendWhatsAppAction($actionData['params'] ?? []);

                case 'create_campaign':
                    return $this->createCampaignAction($actionData['params'] ?? []);

                case 'create_product':
                    return $this->createProductAction($actionData['params'] ?? []);

                case 'create_category':
                    return $this->createCategoryAction($actionData['params'] ?? []);

                default:
                    return [
                        'success' => false,
                        'message' => 'Tipo de acciÃ³n no reconocido'
                    ];
            }
        } catch (\Exception $e) {
            Log::error('Error ejecutando acciÃ³n de IA:', [
                'action' => $actionData,
                'error' => $e->getMessage()
            ]);

            return [
                'success' => false,
                'message' => 'Error ejecutando acciÃ³n: ' . $e->getMessage()
            ];
        }
    }

    /**
     * Create discount action
     */
    private function createDiscountAction($params)
    {
        $controller = new \App\Http\Controllers\Api\AIActionsController();
        $request = new \Illuminate\Http\Request($params);
        $response = $controller->createDiscount($request);

        return $response->getData(true);
    }

    /**
     * Send WhatsApp action
     */
    private function sendWhatsAppAction($params)
    {
        $controller = new \App\Http\Controllers\Api\AIActionsController();
        $request = new \Illuminate\Http\Request($params);
        $response = $controller->sendBulkWhatsApp($request);

        return $response->getData(true);
    }

    /**
     * Create campaign action
     */
    private function createCampaignAction($params)
    {
        $controller = new \App\Http\Controllers\Api\AIActionsController();
        $request = new \Illuminate\Http\Request($params);
        $response = $controller->createCampaign($request);

        return $response->getData(true);
    }

    /**
     * Create product action
     */
    private function createProductAction($params)
    {
        $controller = new \App\Http\Controllers\Api\AIActionsController();
        $request = new \Illuminate\Http\Request($params);
        $response = $controller->createProduct($request);

        return $response->getData(true);
    }

    /**
     * Create category action
     */
    private function createCategoryAction($params)
    {
        $controller = new \App\Http\Controllers\Api\AIActionsController();
        $request = new \Illuminate\Http\Request($params);
        $response = $controller->createCategory($request);

        return $response->getData(true);
    }

    /**
     * Clear conversation history
     */
    public function clearHistory(Request $request)
    {
        try {
            $sessionId = $request->input('session_id');

            if (!$sessionId) {
                return response()->json([
                    'success' => false,
                    'message' => 'session_id es requerido'
                ], 400);
            }

            $deleted = ConversationHistory::where('session_id', $sessionId)->delete();

            return response()->json([
                'success' => true,
                'message' => 'Historial limpiado correctamente',
                'deleted_messages' => $deleted
            ]);

        } catch (\Exception $e) {
            Log::error('Error limpiando historial: ' . $e->getMessage());
            return response()->json([
                'success' => false,
                'message' => 'Error al limpiar historial'
            ], 500);
        }
    }
}
